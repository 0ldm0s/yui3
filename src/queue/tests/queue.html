<!doctype html>
<html>
<head>
    <title>Test Page</title>
    <link type="text/css" rel="stylesheet" href="/assets/dpSyntaxHighlighter.css">
    <link type="text/css" id="locallink" rel="stylesheet" href="../../../build/console/assets/skins/sam/console.css">
    <link type="text/css" rel="stylesheet" href="../../../build/test/assets/test-console.css">
    <style type="text/css" id="styleblock" class="highlight-ignore">
        h1 {
            font: normal 125%/1.4 Arial, sans-serif;
        }
        .yui-skin-sam .yui-console .yui-console-content {
            font-size: 10px;
            width: 32em;
        }
        .yui-skin-sam .yui-console .yui-console-bd {
            height: 50em;
        }
        .yui-skin-sam .yui-console-entry-pass .yui-console-entry-cat {
            background: #070;
            color: #fff;
        }
        .yui-skin-sam .yui-console-entry-fail .yui-console-entry-cat {
            background: #700;
            color: #fff;
        }
        .highlight-example {
            display: inline;
            float: left;
            width: 650px;
        }
        .highlight-example h2 {
            display: none;
        }
    </style>
</head>
<body class="yui-skin-sam">
<h1>Tests</h1>
<div id="testbed"></div>

<script type="text/javascript" src="../../../build/yui/yui.js"></script>
<script type="text/javascript" src="../../../build/queue/queue-debug.js"></script>
<script type="text/javascript">
YUI({
    base : '../../../build/',
    filter : 'debug',
    useBrowserConsole : false,
    logInclude : { TestRunner: true }
}).use('test','console','queue',function (Y) {

var suite = new Y.Test.Suite("Tests");

function f() {}

suite.add(new Y.Test.Case({
    name : "Queue isntantiation",

    test_instantiation : function () {
        var withNew       = new Y.Queue(),
            withoutNew    = Y.Queue(),
            withConfig    = Y.Queue({ timeout: 37 }),
            withCallbacks = Y.Queue(null,f,f,f,f),
            withBoth      = Y.Queue({ context : this },f,f,f,f,f,f);

        Y.Assert.areSame(true, withNew instanceof Y.Queue);
        Y.Assert.areSame(true, withoutNew instanceof Y.Queue);

        Y.Assert.areSame(0, withNew.size());
        Y.Assert.areSame(0, withNew._q.length);
        Y.Assert.areSame(0, withoutNew.size());
        Y.Assert.areSame(0, withoutNew._q.length);

        Y.Assert.areSame(0, withConfig.size());
        Y.Assert.areSame(37, withConfig._defaults.timeout);

        Y.Assert.areSame(4, withCallbacks.size());
        Y.Assert.isObject(withCallbacks._q[0]);
        Y.Assert.areSame(f, withCallbacks._q[0].fn);
        Y.Assert.areSame(withCallbacks, withCallbacks._q[3].context);

        Y.Assert.areSame(6, withBoth.size());
        Y.Assert.areSame(f, withBoth._q[4].fn);
        Y.Assert.areSame(this, withBoth._q[4].context);
    }
}));

suite.add(new Y.Test.Case({
    name : "Test API",

    test_chaining : function () {
        var q = Y.Queue({timeout:10});

        Y.Assert.areSame(q, q.add());
        Y.Assert.areSame(q, q.add(f));
        Y.Assert.areSame(q, q.add(f,f,{fn:f,name:'a'},"garbage"));

        Y.Assert.areSame(q, q.pause());
        Y.Assert.areSame(q, q.promote('a'));
        Y.Assert.areSame(q, q.remove('a'));
        Y.Assert.areSame(q, q.run());
        Y.Assert.areSame(q, q.stop());
    },

    test_add : function () {
        var q = Y.Queue(null, f);

        Y.Assert.areSame(1, q.size());

        q = Y.Queue().add(f);
        Y.Assert.areSame(1, q.size());

        q.add(f,f).add(f,f,f);
        Y.Assert.areSame(6, q.size());

        q.add("Only functions and objects are allowed",
              undefined,
              null,
              1,
              true);

        Y.Assert.areSame(6, q.size());

        q.add({},{}); // empty objects are ok, since config can be defaulted
        Y.Assert.areSame(8, q.size());

        // Add from within a callback
        var count = 0;
        function x() {
            count++;
        }
        function addToQueue() {
            this.add(x);
        }

        // Three x calls scheduled.  A fourth added during a callback
        q = Y.Queue({timeout:-1},x,f,x,addToQueue,f,x).run();
        Y.Assert.areSame(4,count);
    },

    test_remove : function () {
        function X() {
            q.run();
            results += 'X';
        }

        var results = '',
            self = this,
            q = Y.Queue(null,
                    function () {
                        Y.Assert.areSame(9, this.size());
                        results += 'R';
                    },
                    { name: "remove me", fn: X },
                    {
                        name: "not removed",
                        fn: function () {
                            results += 'E';
                            this.remove('dup');
                        },
                        timeout: 10
                    },
                    { name: "dup", fn: X },
                    function () {
                        this.remove("fail");
                        Y.Assert.areSame(4, q.size(),
                            "remove(n) should defer until callback completion");
                        results += 'M';
                    },
                    { name: "dup", fn: X },
                    {name: "fail",
                     fn: function () {
                            Y.Assert.fail("This callback should have been removed");
                         }
                    },
                    { name: "dup", fn: X },
                    function () {
                        Y.Assert.areSame(2, q.size());
                        results += 'OV';
                    },
                    function () {
                        self.resume(function () {
                            results += 'E';
                            Y.Assert.areSame('REMOVE', results);
                        });
                    });

        Y.Assert.areSame(10, q.size());

        // Removal when the Queue is inactive is immediate
        q.remove("remove me");
        Y.Assert.areSame(9, q.size());

        q.run();
        Y.Assert.areSame('R',results);
        Y.Assert.areSame(8, q.size());

        q.remove("not removed");
        Y.Assert.areSame(8, q.size());

        this.wait();
    },

    test_promote : function () {
        function O() {
            results += 'O';
        }

        var results = '',
            self = this,
            q = Y.Queue(null,
                    function () {
                        results += "R";
                    },
                    {
                        name: "p",
                        fn: function () { results += 'P'; }
                    },
                    O,
                    {
                        name: 'm',
                        fn: function () {
                            if (this.count++ > 3) {
                                results += 'M';
                            } else if (!this.count) {
                                q.promote('o');
                            }
                        },
                        context : { count : 0 },
                        iterations : 5
                    },
                    {
                        name : 'o',
                        fn: O,
                        timeout: 10
                    },
                    function () { results += 'E'; },
                    {
                        name : 't',
                        fn : function () {
                            results += 'T';
                        }
                    },
                    function () {
                        self.resume(function () {
                            Y.Assert.areSame('PROMOTE', results);
                        });
                    });

        Y.Assert.isUndefined(q._q[0].name);

        q.promote('p');
        Y.Assert.areSame('p', q._q[0].name);

        q.run();
        Y.Assert.areSame('PROM', results);

        q.promote('t');

        this.wait();
    },

    test_pause : function () {
        var results = '',
            self = this,
            q = Y.Queue(null,
                function () { results += 'P'; },
                {
                    fn: function () {
                        results += 'A';
                    },
                    timeout : 10
                },
                function () {
                    results += 'U';
                },
                function () {
                    results += 'S';
                    this.pause();

                    self.resume(function () {
                        Y.Assert.areSame('PAUS',results);

                        setTimeout(function () {
                            q.run();
                        },10);

                        self.wait();
                    });

                },
                function () {
                    results += 'E';
                    self.resume(function () {
                        Y.Assert.areSame('PAUSE',results);
                    });
                });

        Y.Assert.areSame(5,q.size());
        q.run();

        // Test during timeout
        Y.Assert.areSame('P', results);
        q.pause();

        setTimeout(function () {
            self.resume(function () {
                q.run();
                self.wait();
            });
        }, 20);

        this.wait();
    },

    test_stop : function () {
        var results = "",
            self = this,
            q = Y.Queue(null,
                    function () { results += 'S'; },
                    function () { results += 'T'; },
                    function () { results += 'O'; },
                    function () { results += 'P'; },
                    {
                        fn: function () {
                            self.resume(function () {
                                Y.Assert.fail("Synchronous q.stop() should have cleared this async callback");
                            });
                        },
                        timeout: 10
                    });

        q.run();
        q.stop();
        Y.Assert.areSame('STOP',results);
        Y.Assert.areSame(0,q.size());

        setTimeout(function () {
            self.resume(function () {
                Y.Assert.areSame('STOP',results);
            });
        },100);

        q.run();

        this.wait();
    },

    test_getCallback : function () {
        var c,
            q = Y.Queue({fn: function () {}},
                    { name : 'a', test: 1 },
                    { name : 'b', test: 2, fn: function () {
                            this.pause();
                        }
                    },
                    { name : 'c', test: 3 },
                    { name : 'd', test: 4,
                      fn: function () {
                          Y.Assert.areSame(this._q[0], this.getCallback('d'));
                      }
                    },
                    { name : 'a', test: 5 });

        c = q.getCallback('a');
        Y.Assert.isObject(c);
        Y.Assert.areSame(1, c.test);

        q.run();
        c = q.getCallback('a');
        Y.Assert.isObject(c);
        Y.Assert.areSame(5, c.test);

        q.run();
    },

    test_active : function () {
        var self = this,
            q = Y.Queue(null,
                    function () {
                        Y.Assert.areSame(true, this.active);
                    },
                    {
                        fn: function () {
                            self.resume(function () {
                                q.pause();
                                Y.Assert.areSame(false, q.active);
                            });
                        },
                        timeout: 10
                    },
                    function () {
                        Y.Assert.areSame(true, this.active);
                    });

        Y.Assert.areSame(false, q.active);
        q.run();

        Y.Assert.areSame(true, q.active);

        setTimeout(function () {
            Y.Assert.areSame(false, q.active);
            q.run(); // run to completion
            Y.Assert.areSame(false, q.active);
        },100);

        this.wait();
    }
}));

suite.add(new Y.Test.Case({
    name : "Test callback config",

    test_fn : function () {
        var results = '',
            q = Y.Queue({ fn: function () { results += 'U' } },
                    function () { results += 'R'; },
                    {},
                    function () { results += 'N'; }).run();

        Y.Assert.areSame("RUN", results);

        q.add({ fn : "results += 'X'" },
              { fn : /results += 'X'/ },
              { fn : function () { Y.Assert.areSame("RUN", results); } }).run();
    },

    test_context : function () {
        
    },

    test_args : function () {
    },

    test_iterations : function () {
    },

    test_until : function () {
    },

    test_timeout : function () {
    },

    test_waitForIOResponse : function () {
    }
}));

suite.add(new Y.Test.Case({
    name : "Test Events",

    test_events : function () {
    },

    test_preventCallback : function () {
    }
}));


var yconsole = new Y.Console({
    contentBox:"log",
    newestOnTop: false
}).render();

//yconsole.hideCategory('info');
yconsole.printLogEntry = function (m) {
    if (m.category === 'section') {
        this._addToConsole(Y.Node.create("<h3>"+m.message+"</h3>"));
        return this;
    } else if (m.category === "break") {
        this._addToConsole(Y.Node.create("<br>"));
        return this;
    } else if (m.category === "info") {
        return this;
    } else {
        return Y.Console.prototype.printLogEntry.call(this,m);
    }
};

Y.log("Tests","section","TestRunner");

Y.Test.Runner.add(suite);

Y.Test.Runner.run();

});
</script>
<script type="text/javascript" src="/assets/dpSyntaxHighlighter.js"></script>
<script type="text/javascript" src="/assets/dpSyntaxHighlightExample.js"></script>
</body>
</html>
