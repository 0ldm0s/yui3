<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>DataSource Tests</title>
</head>

<body class="yui-skin-sam">
<h1>DataSource Tests</h1>
<p><input type="button" value="Run Tests" id="btnRun" disabled="true" /></p>

<script type="text/javascript" src="../../../build/yui/yui.js"></script>
<script type="text/javascript" src="../../../build/cache/cache.js"></script>
<script type="text/javascript" src="../../../build/dataparser/dataparser.js"></script>
<script type="text/javascript" src="../../../build/datasource/datasource.js" id="src_ds"></script>
<script type="text/javascript">

(function() {
    YUI({
        base: "../../../build/",
        filter: "debug",
        useConsole: true,
        insertBefore: "src_ds"
    }).use("dump", "test", "console", "io-base", "cache", "base", "plugin", "json", "dataparser", "datasource", function(Y) {

        var ASSERT = Y.Assert,
            ARRAYASSERT = Y.ArrayAssert,
            OBJECTASSERT = Y.ObjectAssert,
            BTNRUN = Y.get("#btnRun"),
            WAITTIMEOUT = 5000; // On a slow connection set to 5000

        // Set up the page
        
        BTNRUN.set("disabled", false);
        Y.on("click", function() {
            Y.Test.Runner.run();
        }, BTNRUN);
        var myConsole = new Y.Console().render();
 
        var testClass = new Y.Test.Case({
            name: "Class Tests",
        
            testConstructor: function() {
                var ds = new Y.DataSource.Local();
                ASSERT.areSame((ds instanceof Y.Base), true, "Expected Base instance.");
                ASSERT.areSame((ds instanceof Y.DataSource.Local), true, "Expected Local instance.");
            },

            testConstructorXHR: function() {
                var ds = new Y.DataSource.XHR();
                ASSERT.areSame((ds instanceof Y.Base), true, "Expected Base instance.");
                ASSERT.areSame((ds instanceof Y.DataSource.Local), true, "Expected Local instance.");
                ASSERT.areSame((ds instanceof Y.DataSource.XHR), true, "Expected XHR instance.");
            }
        });
        
        var testLocal = new Y.Test.Case({
            name: "DataSource Tests",

            testLocalDefaults: function() {
                var ds = new Y.DataSource.Local({
                    source: ["a","b","c","d"]
                });
                

                ds.sendRequest("a", {success:function(e) {
                    ARRAYASSERT.itemsAreSame(["a","b","c","d"], e.response.results, "Expected live array.");
                }});                
            }
        });

        var testLocalEvents = new Y.Test.Case({
            name: "DataSource Event Tests",

            testLocalRequest: function() {
                var ds = new Y.DataSource.Local({
                    source: ["a","b","c","d"]
                });
                
                ds.subscribe("request", function(e) {
                    this.resume(function() {
                        ASSERT.isNumber(e.tId, "Expected transaction ID.");
                        ASSERT.areSame("a", e.request, "Expected request.");
                        ASSERT.areSame("callback", e.callback, "Expected callback.");
                    });
                }, this, true);

                ds.sendRequest("a", "callback");
                this.wait();
            },

            testLocalData: function() {
                var ds = new Y.DataSource.Local({
                    source: ["a","b","c","d"]
                });

                ds.subscribe("data", function(e) {
                    this.resume(function() {
                        ASSERT.isNumber(e.tId, "Expected transaction ID.");
                        ASSERT.areSame("a", e.request, "Expected request.");
                        ASSERT.areSame("callback", e.callback, "Expected callback.");
                        ASSERT.isArray(e.data, "Expected raw data.");
                    });
                }, this, true);

                ds.sendRequest("a", "callback");
                this.wait();
            },

            testLocalResponse: function() {
                var ds = new Y.DataSource.Local({
                    source: ["a","b","c","d"]
                });

                ds.subscribe("response", function(e) {
                    this.resume(function() {
                        ASSERT.isNumber(e.tId, "Expected transaction ID.");
                        ASSERT.areSame("a", e.request, "Expected request.");
                        ASSERT.areSame("callback", e.callback, "Expected callback.");
                        ASSERT.isArray(e.data, "Expected raw data.");
                        ASSERT.isObject(e.response, "Expected normalized response object.");
                        ASSERT.isArray(e.response.results, "Expected parsed results.");
                        ASSERT.isObject(e.response.meta, "Expected parsed meta data.");
                    });
                }, this, true);

                ds.sendRequest("a", "callback");
                this.wait();
            },

            testLocalError: function() {
                var ds = new Y.DataSource.Local({
                    source: ["a","b","c","d"]
                });

                ds.subscribe("error", function(e) {
                    this.resume(function() {
                        ASSERT.isNumber(e.tId, "Expected transaction ID.");
                        ASSERT.areSame("a", e.request, "Expected request.");
                        ASSERT.areSame("callback", e.callback, "Expected callback.");
                        ASSERT.isUndefined(e.response, "Expected undefined response.");
                        ASSERT.isTrue(e.error, "Expected error.");
                    });
                }, this, true);

                ds.set("source", undefined);
                ds.sendRequest("a", "callback");
                this.wait();
            }
        });

        var testXHR = new Y.Test.Case({
            name: "DataSource.XHR Tests",

            testXHRDefaults: function() {
                var ds = new Y.DataSource.XHR({
                    source: "./php/ysearch_json_madonna.php"
                });
                
                ds.sendRequest(null, {
                    success: function(e) {
                        this.resume(function() {
                            ASSERT.isNull(e.request, "Expected null request.");
                            ASSERT.isObject(e.response, "Expected response object.");
                            OBJECTASSERT.ownsAll({tId:null,request:null,data:null,response:null,callback:null}, e, "Expected all properties.");
                        });
                    },
                    failure: function(e) {
                        this.resume(function() {
                            ASSERT.fail("XHR failure case.");
                        });
                    },
                    scope: this
                });                

                this.wait(WAITTIMEOUT);
            }
        });

        var testXHREvents = new Y.Test.Case({
            name: "DataSource.XHR Event Tests",

            testXHRRequest: function() {
                var ds = new Y.DataSource.XHR({
                    source: "./php/ysearch_json_madonna.php",
                });
                ds.plug({fn: Y.plugin.DataSourceJSONParser, cfg: {
                    schema: {
                        resultsList: "ResultSet.Result",
                        fields: ["Title"]
                    }
                }});

                ds.subscribe("request", function(e) {
                    this.resume(function() {
                        ASSERT.isNumber(e.tId, "Expected transaction ID.");
                        ASSERT.areSame(null, e.request, "Expected request.");
                        ASSERT.areSame("callback", e.callback, "Expected callback.");
                    });
                }, this, true);

                ds.sendRequest(null, "callback");
                this.wait(WAITTIMEOUT);
            },

            testXHRData: function() {
                var ds = new Y.DataSource.XHR({
                    source: "./php/ysearch_json_madonna.php",
                });
                ds.plug({fn: Y.plugin.DataSourceJSONParser, cfg: {
                    schema: {
                        resultsList: "ResultSet.Result",
                        fields: ["Title"]
                    }
                }});

                ds.subscribe("data", function(e) {
                    this.resume(function() {
                        ASSERT.isNumber(e.tId, "Expected transaction ID.");
                        ASSERT.areSame(null, e.request, "Expected request.");
                        ASSERT.areSame("callback", e.callback, "Expected callback.");
                        ASSERT.isObject(e.data, "Expected raw data.");
                    });
                }, this, true);

                ds.sendRequest(null, "callback");
                this.wait(WAITTIMEOUT);
            },

            testXHRResponse: function() {
                var ds = new Y.DataSource.XHR({
                    source: "./php/ysearch_json_madonna.php",
                });
                ds.plug({fn: Y.plugin.DataSourceJSONParser, cfg: {
                    schema: {
                        resultsList: "ResultSet.Result",
                        fields: ["Title"]
                    }
                }});

                ds.subscribe("response", function(e) {
                    this.resume(function() {
                        ASSERT.isNumber(e.tId, "Expected transaction ID.");
                        ASSERT.areSame("a", e.request, "Expected request.");
                        ASSERT.areSame("callback", e.callback, "Expected callback.");
                        ASSERT.isObject(e.data, "Expected raw data.");
                        ASSERT.isObject(e.response, "Expected normalized response object.");
                        ASSERT.isArray(e.response.results, "Expected parsed results.");
                        ASSERT.isObject(e.response.meta, "Expected parsed meta data.");
                    });
                }, this, true);

                ds.sendRequest("a", "callback");
                this.wait(WAITTIMEOUT);
            },

            testXHRError: function() {
                var ds = new Y.DataSource.XHR({
                    source: "./php/ysearch_json_madonna.php",
                });
                ds.plug({fn: Y.plugin.DataSourceJSONParser, cfg: {
                    schema: {
                        resultsList: "ResultSet.Result",
                        fields: ["Title"]
                    }
                }});

                ds.subscribe("error", function(e) {
                    this.resume(function() {
                        ASSERT.isNumber(e.tId, "Expected transaction ID.");
                        ASSERT.areSame("a", e.request, "Expected request.");
                        ASSERT.areSame("callback", e.callback, "Expected callback.");
                        ASSERT.isObject(e.data, "Expected raw data.");
                        ASSERT.isTrue(e.error, "Expected error.");
                    });
                }, this, true);

                ds.set("source", "foo");
                ds.sendRequest("a", "callback");
                this.wait(WAITTIMEOUT);
            }
        });

        var testXHRJSONParser = new Y.Test.Case({
            name: "DataSource.XHR JSONParser Tests",

            testPlug: function() {
                var ds = new Y.DataSource.XHR({
                    source: "./php/ysearch_json_madonna.php"
                });
                ds.plug({fn: Y.plugin.DataSourceJSONParser, cfg: {
                    schema: {
                        resultsList: "ResultSet.Result",
                        fields: ["Title"]
                    }
                }});

                ds.sendRequest(null, {
                    success: function(e) {
                        this.resume(function() {
                            ASSERT.isNull(e.request, "Expected null request.");
                            ASSERT.isObject(e.response, "Expected normalized response object.");
                            ASSERT.isArray(e.response.results, "Expected results array.");
                            ASSERT.areSame(10, e.response.results.length, "Expected 10 results.")
                            ASSERT.isNotUndefined(e.response.results[0].Title, "Expected Title property")
                        });
                    },
                    failure: function(e) {
                        this.resume(function() {
                            ASSERT.fail("XHR failure case.");
                        });
                    },
                    scope: this
                });

                this.wait(WAITTIMEOUT);
            }
        });

        var testCaching = new Y.Test.Case({
            name: "DataSource Caching Tests",

            testCacheDefaultMax: function() {
                var ds = new Y.DataSource.Local();
                ds.plug(Y.plugin.DataSourceCache);
                ASSERT.areSame((ds.cache instanceof Y.Cache), true, "Expected Cache instance.");
                ASSERT.areSame(ds.cache.get("max"), 0, "Expected 0 max in Cache.");
            },

            testCacheInitMax: function() {
                var ds = new Y.DataSource.Local();
                ds.plug({fn:Y.plugin.DataSourceCache, cfg:{max:3}});
                ASSERT.areSame((ds.cache instanceof Y.Cache), true, "Expected Cache instance.");
                ASSERT.areSame(ds.cache.get("max"), 3, "Expected 3 max in Cache.");
            },

            testCacheSetMax: function() {
                var ds = new Y.DataSource.Local();
                ds.plug({fn:Y.plugin.DataSourceCache});
                ds.cache.set("max", 5);
                ASSERT.areSame((ds.cache instanceof Y.Cache), true, "Expected Cache instance.");
                ASSERT.areSame(ds.cache.get("max"), 5, "Expected 5 max in Cache.");
            },
            
            testLocalCache: function() {
                var ds = new Y.DataSource.Local({
                        source: ["a","b","c","d"]
                    });
                ds.plug({fn:Y.plugin.DataSourceCache, cfg:{max:3}});

                ds.sendRequest("a");

                ds.subscribe("data", function(e) {
                    ASSERT.fail("Entry should be cached -- 'data' event is unexpected");
                });

                ds.sendRequest("a");
            },

            testLocalCacheUnplug: function() {
                var ds = new Y.DataSource.Local({
                        source: ["a","b","c","d"]
                    });
                ds.plug({fn:Y.plugin.DataSourceCache, cfg:{max:3}});

                ds.sendRequest("a");

                ds.cache.subscribe("retrieve", function(e) {
                    ASSERT.fail("Cache is unset -- 'retrieve' event is unexpected");
                });

                ds.unplug("cache");
                ds.sendRequest("a");
            }
        });

        var testPolling = new Y.Test.Case({
            name: "DataSource Polling Tests",

            testClass: function() {
                var ds = new Y.DataSource.Local();
                ASSERT.isNotUndefined((ds.setInterval), "Expected setInterval() method.");
                ASSERT.isNotUndefined((ds.clearInterval), "Expected clearInterval() method.");
            }
        });

        Y.Test.Runner.add(testClass);
        Y.Test.Runner.add(testLocal);
        Y.Test.Runner.add(testLocalEvents);
        Y.Test.Runner.add(testXHR);
        Y.Test.Runner.add(testXHREvents);
        Y.Test.Runner.add(testXHRJSONParser);
        Y.Test.Runner.add(testCaching);
        //Y.Test.Runner.add(testPolling);
        Y.Test.Runner.run();
    });
})();
</script>
</body>
</html>
