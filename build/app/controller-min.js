YUI.add("controller",function(a){var g=a.HistoryHash,b=a.QueryString,h=a.Array,e=a.HistoryBase.html5&&(!a.UA.android||a.UA.android>=3),f=a.config.win,i=f.location,d="ready";function c(){c.superclass.constructor.apply(this,arguments);}a.Controller=a.extend(c,a.Base,{base:"",dispatchOnInit:!e,routes:[],_html5:e,_regexPathParam:/([:*])([\w\d-]+)/g,_regexUrlQuery:/\?([^#]*).*$/,initializer:function(k){var j=this;k||(k={});k.base&&(j.base=k.base);k.routes&&(j.routes=k.routes);if(a.Lang.isValue(k.dispatchOnInit)){j.dispatchOnInit=k.dispatchOnInit;}j._routes=[];h.each(j.routes,function(l){j.route(l.path,l.callback,true);});if(e){j._history=new a.HistoryHTML5({force:true});j._history.after("change",j._afterHistoryChange,j);}else{a.on("hashchange",j._afterHistoryChange,f,j);}j.publish(d,{defaultFn:j._defReadyFn,fireOnce:true,preventable:false});j.once("initializedChange",function(){setTimeout(function(){j.fire(d,{dispatched:!!j._dispatched});},20);});},destructor:function(){if(e){this._history.detachAll();}else{a.detach("hashchange",this._afterHistoryChange,f);}},match:function(j){return h.filter(this._routes,function(k){return j.search(k.regex)>-1;});},replace:function(j){return this._save(j,true);},route:function(k,l){var j=[];this._routes.push({callback:l,keys:j,path:k,regex:this._getRegex(k,j)});return this;},save:function(j){return this._save(j);},_decode:function(j){return decodeURIComponent(j.replace(/\+/g," "));},_dispatch:function(n){var k=this,j=k.match(n),m;k._dispatched=true;if(!j||!j.length){return;}m=k._getRequest(n);function l(p){var r,q,o;if(p){a.error(p);}else{if((o=j.shift())){q=o.regex.exec(n);r=typeof o.callback==="string"?k[o.callback]:o.callback;if(q.length===o.keys.length+1){m.params=h.hash(o.keys,q.slice(1));}else{m.params={};h.each(q,function(t,s){m.params[s]=t;});}r.call(k,m,l);}}}l();},_getHashPath:function(){return g.getHash().replace(this._regexUrlQuery,"");},_getPath:(function(){var j=this;function k(m){var l=j.base;if(l&&m.indexOf(l)===0){m=m.substring(l.length);}return m;}return e?function(){return k(i.pathname);}:function(){return this._getHashPath()||k(i.pathname);};}()),_getQuery:e?function(){return i.search.substring(1);}:function(){var k=g.getHash(),j=k.match(this._regexUrlQuery);return k&&j?j[1]:i.search.substring(1);},_getRegex:function(k,j){if(k instanceof RegExp){return k;}k=k.replace(this._regexPathParam,function(m,l,n){j.push(n);return l==="*"?"(.*?)":"([^/]*)";});return new RegExp("^"+k+"$");},_getRequest:function(j){return{path:j,query:this._parseQuery(this._getQuery())};},_parseQuery:b&&b.parse?b.parse:function(m){var n=this._decode,p=m.split("&"),l=0,k=p.length,j={},o;for(;l<k;++l){o=p[l].split("=");if(o[0]){j[n(o[0])]=n(o[1]||"");}}return j;},_save:e?function(j,k){this._ready=true;this._history[k?"replace":"add"](null,{url:typeof j==="string"?this.base+j:j});return this;}:function(j,k){this._ready=true;g[k?"replaceHash":"setHash"](j);return this;},_afterHistoryChange:function(k){var j=this;if(j._ready){setTimeout(function(){j._dispatch(j._getPath());},1);}},_defReadyFn:function(k){var j;this._ready=true;if(this.dispatchOnInit&&!this._dispatched){if(e&&(j=this._getHashPath())){this._history.replace(null,{url:this.base+j});}else{this._dispatch(this._getPath());}}}},{NAME:"controller"});},"@VERSION@",{optional:["querystring-parse"],requires:["array-extras","base-build","history"]});