YUI.add("logreader",function(A){A.log.Reader=function(){this.constructor.superclass.constructor.apply(this,arguments);};A.mix(A.log.Reader,{NAME:"logreader",PLUGINS:[],CLASSES:{CONTAINER:"yui-log",HD:"yui-log-hd",CONSOLE:"yui-log-console",FT:"yui-log-ft",HIDE_FT:"yui-log-hide-ft",CONTROLS:"yui-log-controls",BUTTON:"yui-log-button",LABEL:"yui-log-label",CHECKBOX:"yui-log-checkbox",COLLAPSE:"yui-log-collapse",EXPAND:"yui-log-expand",ACTIVE:"yui-log-active",CLEAR:"yui-log-clear",CAT_CHECKS:"yui-log-categories",SRC_CHECKS:"yui-log-sources",CATEGORY:"yui-log-category",SOURCE:"yui-log-source",ENTRY:"yui-log-entry",VERBOSE:"yui-log-verbose",ENTRY_META:"yui-log-entry-meta",ENTRY_CAT:"yui-log-entry-cat",ENTRY_SRC:"yui-log-entry-src",ENTRY_TIME:"yui-log-entry-time",ENTRY_TYPE:"yui-log-entry-type",HIDE_BASE:"yui-log-hide-",ENTRY_TYPE_BASE:"yui-log-entry-type-"},STRINGS:{COLLAPSE:"Collapse",EXPAND:"Expand",ACTIVE:"Active",CLEAR:"Clear"},VERBOSE:"verbose",BASIC:"basic",ATTRS:{title:{value:"Log Console"},enabled:{value:true},active:{value:true},defaultCategory:{value:"info"},defaultSource:{value:"global"},entryTypes:{value:{category:{info:true,warn:true,error:true,time:true},source:{global:true}}},templates:{value:{verbose:null,basic:null}},defaultTemplate:{value:"verbose"},entryWriters:{value:{entry:"_entryFromTemplate"}},defaultWriter:{value:"entry"},printTimeout:{value:100,validator:A.Lang.isNumber},consoleLimit:{value:500},footerEnabled:{value:true},verbose:{value:true,set:function(B){this.set("defaultTemplate",(B?A.log.Reader.VERBOSE:A.log.Reader.BASIC));return !!B;}},newestOnTop:{value:true},collapsed:{value:false},startTime:{value:new Date()},lastTime:{value:new Date()}}});A.extend(A.log.Reader,A.Widget,{_head:null,_title:null,_console:null,_foot:null,_catChecks:null,_srcChecks:null,_timeout:null,buffer:null,initializer:function(B){this.buffer=[];this._initObjectAttributes();this._initTemplates();A.on("yui:log",A.bind(this._handleLogEntry,this));},_initObjectAttributes:function(){var B=["entryTypes","templates","entryWriters"],C=B.length-1;for(;C>=0;--C){this.set(B[C],A.clone(this.get(B[C])),true);}},_initTemplates:function(){var B=A.log.Reader.CLASSES;this.set("templates.verbose",'<pre class="'+B.ENTRY+" "+B.VERBOSE+'">'+'<div class="'+B.ENTRY_META+'">'+"<p>"+'<span class="'+B.ENTRY_CAT+'">{label}</span>'+'<span class="'+B.ENTRY_TIME+'">'+" {totalTime}ms (+{elapsedTime}) {localTime}:"+"</span>"+"</p>"+'<p class="'+B.ENTRY_SRC+'">{sourceAndDetail}</p>'+"</div>"+"<p>{message}</p>"+"</pre>");this.set("templates.basic",'<pre class="'+B.ENTRY+'">'+"<p>"+'<span class="'+B.ENTRY_META+'">'+'<span class="'+B.ENTRY_CAT+'">{label}</span>'+'<span class="'+B.ENTRY_TIME+'">'+" {totalTime}ms (+{elapsedTime}) {localTime}:"+"</span>"+'<span class="'+B.ENTRY_SRC+'">'+" {sourceAndDetail}"+"</span>:"+"</span>"+" {message}"+"</p>"+"</pre>");},renderer:function(){A.log.Reader.superclass.renderer.apply(this,arguments);this.renderUI();this.syncUI();this.bindUI();},renderUI:function(){if(!this.get("rendered")){this.get("contentBox").set("innerHTML","");this.get("contentBox").addClass(A.log.Reader.CLASSES.CONTAINER);this._renderHead();this._renderConsole();this._renderFoot();}},_renderHead:function(){var D=A.log.Reader.CLASSES,B=A.log.Reader.STRINGS;this._head=A.Node.create('<div class="'+D.HD+'">'+'<div class="'+D.CONTROLS+'">'+'<input type="button" class="'+D.BUTTON+" "+D.COLLAPSE+'"'+' value="'+B.COLLAPSE+'">'+'<input type="button" class="'+D.BUTTON+" "+D.EXPAND+'"'+' value="'+B.EXPAND+'">'+"</div>"+"<h4>"+this.get("title")+"</h4>"+"</div>");this._title=this._head.query("h4");this.get("contentBox").insertBefore(this._head,this.get("contentBox").get("firstChild")||null);},_renderConsole:function(){this._console=this.get("contentBox").insertBefore(A.Node.create('<div class="'+A.log.Reader.CLASSES.CONSOLE+'"></div>'),this._foot||null);},_renderFoot:function(){var F=A.log.Reader.CLASSES,E=A.log.Reader.STRINGS,B,D;this._foot=A.Node.create('<div class="'+F.FT+'">'+'<div class="'+F.CONTROLS+'">'+'<label class="'+F.LABEL+'">'+'<input type="checkbox" class="'+F.CHECKBOX+" "+F.ACTIVE+'" value="1"> '+E.ACTIVE+"</label>"+'<input type="button" class="'+F.BUTTON+" "+F.CLEAR+'"'+' value="'+E.CLEAR+'">'+"</div>");this._catChecks=this._foot.appendChild(A.Node.create('<div class="'+F.CONTROLS+" "+F.CAT_CHECKS+'"></div>'));this._srcChecks=this._foot.appendChild(A.Node.create('<div class="'+F.CONTROLS+" "+F.SRC_CHECKS+'"></div>'));B=this.get("entryTypes.category");for(D in B){if(B.hasOwnProperty(D)){this._catChecks.appendChild(this._createEntryType(F.CATEGORY,D));}}B=this.get("entryTypes.source");for(D in B){if(B.hasOwnProperty(D)){this._srcChecks.appendChild(this._createEntryType(F.SOURCE,D));}}this.get("contentBox").appendChild(this._foot);},syncUI:function(){var D=A.log.Reader.CLASSES,B;this._setActive(this.get("active"));this._setCollapsed(this.get("collapsed"));this._setFooterEnabled(this.get("footerEnabled"));B=this.get("entryTypes.category");this._foot.queryAll("input[type=checkbox]."+D.CATEGORY).each(function(C){C.set("checked",(C.get("value") in B)?B[C.get("value")]:true);});B=this.get("entryTypes.source");this._foot.queryAll("input[type=checkbox]."+D.SOURCE).each(function(C){C.set("checked",(C.get("value") in B)?B[C.get("value")]:true);});},bindUI:function(){var B=this.get("contentBox").queryAll("."+A.log.Reader.CLASSES.CONTROLS),C=B.size()-1;for(;C>=0;--C){B.item(C).on("click",A.bind(this._handleControlClick,this));}this.after("titleChange",A.bind(this._setTitle,this));this.after("activeChange",A.bind(this._setActive,this));this.after("collapsedChange",A.bind(this._setCollapsed,this));this.after("consoleLimitChange",A.bind(this._setConsoleLimit,this));this.after("footerEnabledChange",A.bind(this._setFooterEnabled,this));this.after("entryTypesChange",A.bind(this._handleEntryTypesChange,this));},_handleControlClick:function(D){var E=A.log.Reader.CLASSES,B=D.target;if(B.hasClass(E.COLLAPSE)){this.set("collapsed",true);}else{if(B.hasClass(E.EXPAND)){this.set("collapsed",false);
}else{if(B.hasClass(E.ACTIVE)){this.set("active",B.get("checked"));}else{if(B.hasClass(E.CLEAR)){this.clearConsole();}else{if(B.hasClass(E.FILTER)){this.set("entryTypes."+(B.hasClass(E.CATEGORY)?"category.":"source.")+B.get("value"),B.get("checked"));}}}}}},_setTitle:function(B){B=typeof B=="object"?B.newVal:B;this._title.set("innerHTML",B);},_setActive:function(B){B=typeof B=="object"?B.newVal:B;var C=this._foot.queryAll("input[type=checkbox]."+A.log.Reader.CLASSES.ACTIVE),D=C.size()-1;for(;D>=0;--D){C.item(D).set("checked",!!B);}if(B){this._schedulePrint();}else{if(this._timeout){clearTimeout(this._timeout);this._timeout=null;}}},_setCollapsed:function(B){B=typeof B=="object"?B.newVal:B;this.get("contentBox")[B?"addClass":"removeClass"](A.log.Reader.CLASSES.COLLAPSE);},_setConsoleLimit:function(B){B=typeof B==="object"?B.newVal:B;this._trimOldEntries(B);},clearConsole:function(){this._console.set("innerHTML","");if(this._timeout){clearTimeout(this._timeout);this._timeout=null;}this.buffer=[];},reset:function(){this.clearConsole();this.set("startTime",new Date());this.set("enabled",true);this.set("active",true);this.fire("reset");},_handleLogEntry:function(F,C,E){if(this.get("enabled")){var B=this.normalizeMessage(F,C,E),D=this.get("entryTypes");if(B){if(B.category&&!(B.category in D.category)){this.createCategory(B.category,true);}if(B.source&&!(B.source in D.source)){this.createSource(B.source,true);}this.buffer.push(B);this._schedulePrint();}}},normalizeMessage:function(E,C,D){var B={time:new Date(),message:E,category:C||this.get("defaultCategory"),sourceAndDetail:D||this.get("defaultSource"),source:null,label:null,localTime:null,elapsedTime:null,totalTime:null};B.source=/^(\S+)\s/.test(B.sourceAndDetail)?RegExp.$1:B.sourceAndDetail;B.label=B.category;B.localTime=B.time.toLocaleTimeString?B.time.toLocaleTimeString():(B.time+"");B.elapsedTime=B.time-this.get("lastTime");B.totalTime=B.time-this.get("startTime");this.set("lastTime",B.time);return B;},_schedulePrint:function(){if(this.get("active")&&!this._timeout){this._timeout=setTimeout(A.bind(this.printBuffer,this),this.get("printTimeout"));}},printBuffer:function(){var C=A.debug;A.debug=false;if(this.get("active")&&this.get("rendered")){clearTimeout(this._timeout);this._timeout=null;var E=this.buffer,D=0,B=E.length;this.buffer=[];for(;D<B;++D){this.printLogEntry(E[D]);this._trimOldEntries();}}A.debug=C;},printLogEntry:function(B){var E=this.get("entryWriters"),D=E[B.cat]||E[this.get("defaultWriter")],C;C=typeof D==="function"?D.call(this,B):this[D](B);if(C){if(this.get("newestOnTop")){this._console.insertBefore(C,this._console.get("firstChild"));}else{this._console.appendChild(C);this._console.set("scrollTop",this._console.get("scrollHeight"));}}},_entryFromTemplate:function(B){B=this._htmlEscapeMessage(B);var D=this.get("templates"),C=D[B.category]||D[this.get("defaultTemplate")],E=A.Node.create(A.Lang.substitute(C,B));E.addClass(this._filterClass(B.category));E.addClass(this._filterClass(B.source));return E;},_htmlEscapeMessage:function(B){function C(D){return D.replace(/&/g,"&#38;").replace(/</g,"&#60;").replace(/>/g,"&#62;");}B=A.clone(B);B.message=typeof B.message==="string"?C(B.message):B.message;B.label=typeof B.label==="string"?C(B.label):B.label;B.source=typeof B.source==="string"?C(B.source):B.source;B.sourceAndDetail=typeof B.sourceAndDetail==="string"?C(B.sourceAndDetail):B.sourceAndDetail;B.category=typeof B.category==="string"?C(B.category):B.category;return B;},_trimOldEntries:function(C){if(this._console){var B=this._console.get("childNodes"),E=B.size()-((C|0)||this.get("consoleLimit"));if(E>0){if(this.get("newestOnTop")){for(var D=B.size();E<D;E++){this._console.removeChild(B.item(E));}}else{for(;E>=0;--E){this._console.removeChild(B.item(E));}}}}},hideEntries:function(C){var B=this.get("entryTypes"),D;for(D in B){if(B.hasOwnProperty(D)&&B[D].hasOwnProperty(C)){this.set("entryTypes."+D+"."+C,false);}}},showEntries:function(C){var B=this.get("entryTypes"),D;for(D in B){if(B.hasOwnProperty(D)&&B[D].hasOwnProperty(C)){this.set("entryTypes."+D+"."+C,true);}}},_setEntryType:function(C,E){var B=this._foot.queryAll("input[type=checkbox]."+this._filterClass(C)),D=B.size()-1;for(;D>=0;--D){B.item(D).set("checked",E);}this._filterEntries(C,!E);},_filterEntries:function(C,B){this.get("contentBox")[B?"addClass":"removeClass"](this._filterClass(C,true));},_setFooterEnabled:function(B){this.get("contentBox")[B?"removeClass":"addClass"](A.log.Reader.CLASSES.HIDE_FT);},createCategory:function(C,B){this.set("entryTypes.category."+C,!!B);},createSource:function(C,B){this.set("entryTypes.source."+C,!!B);},_createEntryType:function(E,D){var F=A.log.Reader.CLASSES,B=A.Node.create('<label class="'+F.LABEL+'">'+'<input type="checkbox" value="'+D+'" class="'+F.FILTER+" "+E+" "+this._filterClass(D)+'"> '+D+"</label>");A.StyleSheet("logreader").setCSS("."+this._filterClass(D,true)+" ."+A.log.Reader.CLASSES.CONSOLE+" ."+this._filterClass(D),{display:"none"});return B;},_filterClass:function(B,C){return A.log.Reader.CLASSES[(C?"HIDE_BASE":"ENTRY_TYPE_BASE")]+B;},_handleEntryTypesChange:function(K){var D=A.log.Reader.CLASSES,M=function(O){var N=[];function C(R,Q){if(typeof R==="object"){for(var P in R){if(R.hasOwnProperty(P)){C(R[P],Q.concat(P));}}}else{if(Q){N.push(Q);}}}C(O,[]);return N;},E=function(Q,P){var N=Q,O=0,C=P.length;for(;O<C&&N!==undefined;++O){N=N[P[O]];}return N;},L=M(K.prevVal),I=M(K.newVal),G={},H=0,F=L.length,B,J;for(;H<F;++H){J=E(K.newVal,L[H]);if(E(K.prevVal,L[H])!==J){B=L[H][1];this._setEntryType(B,J);}G[L[H].join(".")]=true;}for(H=0,F=I.length;H<F;++H){if(!G[I[H].join(".")]){B=I[H][1];if(I[H][0]=="category"){this._catChecks.appendChild(this._createEntryType(D.CATEGORY,B));}else{this._srcChecks.appendChild(this._createEntryType(D.SOURCE,B));}this._setEntryType(B,E(K.newVal,I[H]));}}}});},"@VERSION@",{requires:["substitute","stylesheet","widget"]});